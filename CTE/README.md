---

# Common Table Expression (CTE) in MySQL

A **Common Table Expression (CTE)** is a temporary, named result set that simplifies complex queries, making them more readable and maintainable. CTEs can be particularly useful in scenarios where the same subquery logic needs to be reused within a larger query.

## Syntax

The basic syntax for defining a CTE in MySQL is as follows:

```sql
WITH cte_name AS (
    SELECT column1, column2, ...
    FROM table_name
    WHERE condition
)
SELECT *
FROM cte_name;
```

You can define multiple CTEs in the same query by separating each CTE with a comma.

## Examples

### Example 1: Total Revenue Calculation

Imagine you have a `sales` table with the following columns:

- `product_name`
- `sales_date`
- `revenue`

You want to calculate the total revenue for each product over the past 30 days and compare it to the previous 30-day period.

```sql
WITH sales_last_30_days AS (
    SELECT product_name, SUM(revenue) AS total_revenue
    FROM sales
    WHERE sales_date BETWEEN '2023-03-10' AND '2023-04-09'
    GROUP BY product_name
),
sales_previous_30_days AS (
    SELECT product_name, SUM(revenue) AS total_revenue
    FROM sales
    WHERE sales_date BETWEEN '2023-02-08' AND '2023-03-09'
    GROUP BY product_name
)
SELECT
    s.product_name,
    s.total_revenue,
    (s.total_revenue - p.total_revenue) / p.total_revenue * 100 AS revenue_change
FROM sales_last_30_days s
JOIN sales_previous_30_days p ON s.product_name = p.product_name;
```

**Explanation**:  
- `sales_last_30_days`: Calculates total revenue for each product in the last 30 days.
- `sales_previous_30_days`: Calculates total revenue for each product in the previous 30-day period.
- The main query joins these two CTEs to compute the percentage change in revenue.

### Example 2: Monthly Sales Report

Assume you have a `sales` table with the following columns:

- `order_date`
- `product`
- `quantity`
- `revenue`

You want to generate a monthly sales report that shows the total revenue generated by each product, broken down by month, along with the percentage of total revenue for each product.

```sql
WITH monthly_sales AS (
  SELECT
    DATE_FORMAT(order_date, '%Y-%m') AS month,
    product,
    SUM(revenue) AS revenue
  FROM sales
  GROUP BY month, product
),
total_sales AS (
  SELECT
    month,
    SUM(revenue) AS total_revenue
  FROM monthly_sales
  GROUP BY month
)
SELECT
  monthly_sales.month,
  monthly_sales.product,
  monthly_sales.revenue,
  (monthly_sales.revenue / total_sales.total_revenue) * 100 AS percentage
FROM
  monthly_sales
JOIN total_sales ON monthly_sales.month = total_sales.month
ORDER BY monthly_sales.month, percentage DESC;
```

**Explanation**:  
- `monthly_sales`: Aggregates revenue by product for each month.
- `total_sales`: Calculates the total revenue for each month.
- The main query combines these CTEs to calculate the percentage of total revenue each product contributes within its respective month.

## Benefits of Using CTEs

- **Simplifies Complex Queries**: Break down complex queries into more manageable parts.
- **Improves Readability**: Names for CTEs make the query easier to understand.
- **Enhances Performance**: Reduces the need for repeated subqueries.
- **Reusability**: Allows for reuse of the same logic within a query.
- **Ease of Debugging**: Easier to isolate and test parts of the query.
- **Hierarchical Data**: Facilitates working with hierarchical or recursive data structures.

CTEs are an essential tool in MySQL that enhances both the performance and maintainability of your SQL queries. 
--- 
